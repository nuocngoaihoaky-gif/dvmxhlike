name: Production_Infrastructure_Monitor

on:
  schedule:
    - cron: '0 */2 * * *' # Chạy mỗi 2 giờ (Bot sẽ tự kill process cũ để chạy mới)
  workflow_dispatch:      # Cho phép chạy thủ công

jobs:
  system-check:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    steps:
      # 1. Hủy các phiên chạy cũ bị treo (Cực kỳ quan trọng để reset bot mỗi 2 tiếng)
      - name: Prune Stale Processes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          runs=$(gh run list --repo ${{ github.repository }} --status in_progress --json databaseId --jq ".[] | select(.databaseId != ${{ github.run_id }}) | .databaseId")
          for run_id in $runs; do
            gh run cancel $run_id --repo ${{ github.repository }}
          done

      - uses: actions/checkout@v2

      - uses: actions/setup-python@v2
        with:
          python-version: '3.11'

      # 2. Cài đặt thư viện (ĐÃ SỬA: Thêm aiohttp)
      - name: Install Dependencies
        run: pip install aiohttp telethon requests
        # Note: Vẫn giữ requests phòng hờ, nhưng quan trọng nhất là aiohttp

      # 3. Khôi phục file Session (Đăng nhập Telegram)
      - name: Restore Session Cache
        env:
          CACHE_BLOB: ${{ secrets.CACHE_DB_B64 }}
        run: |
          # Giải mã base64 ra file session
          echo "$CACHE_BLOB" | base64 -d > monitor_cache.session

      # 4. Chạy Code Python
      - name: Execute Diagnostics
        env:
          AWS_CLUSTER_ID: ${{ secrets.AWS_CLIENT_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          # Các biến môi trường khác nếu cần
        timeout-minutes: 350 # Set 350 phút (< 6 tiếng) để an toàn
        run: python -u ci_test.py
